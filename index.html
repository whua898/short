<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="asset/img/favicon.png"  >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>short</title>
    <style>
      :root {
        --color-primary: #5c7cfa;
        --color-primary-dark: #4263eb;
        --color-primary-alpha: #5c7cfa50;

        --body-color: #495057;
        --body-bg: #f8f9fa;

        --border-color: #dee2e6;
      }

      body {
        max-width: 30rem;
        margin-left: auto;
        margin-right: auto;
        padding-left: 2rem;
        padding-right: 2rem;
        color: var(--body-color);
        background: var(--body-bg);
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.5;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        text-rendering: optimizelegibility;
        -webkit-font-smoothing: antialiased;
      }

      a {
        color: var(--color-primary);
        text-decoration: none;
        transition: color .3s;
      }

      a:hover {
        color: var(--color-primary);
        text-decoration: underline;
      }

      h1 {
        font-size: 3rem; /* 减小标题字号 */
        font-weight: 300;
        text-align: center;
        opacity: .2;
        margin-bottom: 1.5rem; /* 减小标题下边距 */
      }

      main[x-cloak] {
        opacity: 0;
      }

      main:not([x-cloak]) {
        opacity: 1;
        transition: opacity .3s;
      }

      input, select {
        -webkit-appearance: none;
        appearance: none;
        display: block;
        width: 100%;
        padding: .5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: .25rem;
        box-sizing: border-box;
        color: #33404d;
        line-height: inherit;
        font-size: 1rem;
        transition: border .3s, box-shadow .3s;
      }

      input:focus, select:focus {
        box-shadow: 0 0 0 .25rem var(--color-primary-alpha);
        border-color: var(--color-primary);
        outline: 0;
      }

      details {
        margin: 1rem 0 1.5rem; /* 减小 details 上下边距 */
        border: 1px solid var(--border-color);
        border-radius: .25rem;
        transition: background .3s;
      }

      details[open] {
        background: #fff;
      }

      details summary {
        padding: .5rem 1rem;
        font-weight: 500;
        user-select: none;
        cursor: pointer;
        opacity: .8;
        outline: 0;
      }

      details div {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
      }

      details small {
        margin: 0;
        font-size: .875rem;
        line-height: 2;
        display: block; /* 确保换行 */
        color: #868e96;
      }

      button {
        appearance: none;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-bottom: 3rem; /* 减小按钮下边距 */
        padding: .5rem .75rem;
        border: 1px solid var(--color-primary);
        border-radius: .25rem;
        background: var(--color-primary);
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
        line-height: inherit;
        cursor: pointer;
        user-select: none;
        transition: border .3s, background .3s,;
      }

      button:hover {
        border-color: var(--color-primary-dark);
        background: var(--color-primary-dark);
      }

      button:focus {
        box-shadow: 0 0 0 .25rem var(--color-primary-alpha);
        border-color: var(--color-primary);
        outline: 0;
      }

      button:disabled {
        background: var(--color-primary);
        border-color: var(--color-primary);
        opacity: .6;
        cursor: not-allowed;
      }

      button.loading::before {
        content: '';
        display: inline-block;
        margin-right: .5rem;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-bottom-color: transparent;
        border-radius: 50%;
        width: .75rem;
        height: .75rem;
        animation: rotate .5s linear infinite;
      }

      /* 新增：查询按钮样式 */
      .query-btn {
        margin-top: 0.5rem;
        margin-bottom: 0;
        background: #fff;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
      }
      .query-btn:hover {
        background: var(--color-primary-alpha);
        color: var(--color-primary-dark);
        border-color: var(--color-primary-dark);
      }

      footer {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        opacity: .5;
      }

      footer i {
        font-style: normal;
        color: #ff8787;
      }

      .success,
      .error {
        margin-bottom: 1rem;
        padding: .5rem 1rem;
        border-radius: .25rem;
        color: #fff;
        text-align: center;
        opacity: 1;
        transition: opacity .3s;
      }

      .success {
        border: 1px solid #12b886;
        background: #38d9a9;
      }

      .error {
        border: 1px solid #fa5252;
        background: #ff8787;
      }

      @keyframes rotate {
        100% {
          transform: rotate(360deg);
        }
      }

      .github-icon {
        display: inline-block;
        vertical-align: middle;
        width: 36px;
        height: 36px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3Cpath d='M12 2C6.475 2 2 6.475 2 12a9.994 9.994 0 0 0 6.838 9.488c.5.087.687-.213.687-.476 0-.237-.013-1.024-.013-1.862-2.512.463-3.162-.612-3.362-1.175-.113-.288-.6-1.175-1.025-1.413-.35-.187-.85-.65-.013-.662.788-.013 1.35.725 1.538 1.025.9 1.512 2.362 1.087 2.937.825.088-.65.35-1.087.638-1.337-2.225-.25-4.55-1.113-4.55-4.938 0-1.088.387-1.987 1.025-2.688-.1-.25-.45-1.275.1-2.65 0 0 .837-.262 2.75 1.026a9.28 9.28 0 0 1 2.5-.338c.85 0 1.7.112 2.5.338 1.912-1.287 2.75-1.025 2.75-1.025.55 1.375.2 2.4.1 2.65.637.7 1.025 1.587 1.025 2.687 0 3.838-2.337 4.688-4.562 4.938.362.312.675.912.675 1.85 0 1.337-.013 2.412-.013 2.75 0 .262.188.575.688.475A9.994 9.994 0 0 0 22 12c0-5.525-4.475-10-10-10z' fill='%23495057'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        opacity: 0.5;
        transition: opacity 0.3s;
      }

      .github-icon:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header><h1>short</h1></header>
    <main x-data="app" x-init="loadCustomSlugs()" x-cloak>
      <p x-show.transition.opacity="alert" :class="alert?.type" x-text="alert?.message"></p>
      <input placeholder="输入要缩短的网址..." x-model="url" x-ref="url" />

      <!-- 修改：默认展开 -->
      <details open>
        <summary>自定义设置 / 反查</summary>
        <div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: bold;">生成短链：</label>
            <input placeholder="输入自定义后缀 (slug)" x-model="slug" />
            <small>留空则随机生成。若输入已存在的后缀，将尝试覆盖。</small>
          </div>

          <div style="border-top: 1px dashed var(--border-color); margin: 1rem 0;"></div>

          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: bold;">反查长链：</label>
            <!-- 下拉列表 -->
            <select id="custom-slug-select" @change="selectCustomSlug($event.target.value)" style="margin-bottom: 0.5rem;">
              <option value="">-- 从历史记录选择 --</option>
              <template x-for="item in customSlugs" :key="item.slug">
                <option :value="item.url" x-text="item.slug"></option>
              </template>
              <option value="" disabled x-show="customSlugs.length === 0">暂无历史记录</option>
            </select>

            <!-- 手动查询 -->
            <div style="display: flex; gap: 0.5rem;">
                <input placeholder="输入后缀反查..." x-model="querySlug" style="flex: 1;" />
                <button class="query-btn" style="width: auto;" @click="queryBySlug()" :disabled="!querySlug">查询</button>
            </div>
          </div>

        </div>
      </details>
      <button :class="{ loading }" :disabled="loading || isValidated()" @click="submit($refs, $nextTick)">生成短链</button>
    </main>
    <footer>
     <a href="https://github.com/whua898/short" target="_blank" title="GitHub Repository">
        <span class="github-icon"></span>
     </a>
    </footer>
    <script src="asset/js/alpine.js"></script>
    <script>
      const app = {
        url: '',
        slug: '',
        querySlug: '', // 用于手动查询的 slug
        alert: null,
        loading: false,
        customSlugs: [],

        isValidated () {
          return !/^https?:\/\/.{3,}/.test(this.url)
        },

        loadCustomSlugs() {
          fetch('/list')
            .then(res => res.json())
            .then(res => {
              if (res.Code === 1 && Array.isArray(res.Data)) {
                this.customSlugs = res.Data;
              }
            })
            .catch(e => console.error('Failed to load custom slugs:', e));
        },

        selectCustomSlug(selectedUrl) {
          if (selectedUrl) {
            this.url = selectedUrl;
            // 同时也把 slug 填进去，方便用户看
            const selectedItem = this.customSlugs.find(item => item.url === selectedUrl);
            if (selectedItem) {
                this.slug = selectedItem.slug;
                this.querySlug = selectedItem.slug; // 也填入查询框
            }
            this.alert = { type: 'success', message: '已反填长链接' };
          }
        },

        // 手动查询功能
        queryBySlug() {
            if (!this.querySlug) return;

            this.loading = true;
            this.alert = null;

            fetch('/query', {
                method: 'post',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ slug: this.querySlug })
            })
            .then(res => res.json())
            .then(res => {
                this.loading = false;
                if (res.Code === 1) {
                    this.url = res.LongUrl;
                    this.slug = res.Slug; // 同时也填入生成框，方便用户直接覆盖
                    this.alert = { type: 'success', message: `查询成功！长链接已反填。创建时间: ${res.CreateTime}` };
                } else {
                    this.alert = { type: 'error', message: res.Message || '未找到该短链' };
                    this.url = ''; // 清空 url 以免误导
                }
            })
            .catch(e => {
                this.loading = false;
                this.alert = { type: 'error', message: e.message };
            });
        },

        submit ($refs, $nextTick) {
          if (!this.url) {
            this.alert = { type: 'error', message: '缺少必需的参数：url。' }
            return
          }

          if (this.isValidated()) {
            this.alert = { type: 'error', message: '非法格式：url。' }
            return
          }

          this.alert = null
          this.loading = true

          const body = { url: this.url, overwrite: true } // 默认开启覆盖，或者让用户选择？这里为了方便直接开启
          if (this.slug) body.slug = this.slug

          fetch('/short', {
            method: 'post',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(body)
          })
            .then(res => res.json())
            .then(res => {
              this.loading = false
              if (res.Code !== 1) {
                this.alert = { type: 'error', message: res.Message || '未知错误' }
                return
              }

              this.url = res.ShortUrl

              if (this.slug) {
                  this.loadCustomSlugs();
              }

              $nextTick(() => {
                $refs.url.select()
                this.alert = { type: 'success', message: `链接 ${document.execCommand('Copy') ? '复制' : '生成'} ` }
              })
            })
            .catch(e => {
              this.alert = { type: 'error', message: e.message }
              this.loading = false
            })
        }
      }
    </script>
  </body>
</html>
