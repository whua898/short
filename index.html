<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="asset/img/favicon.png"  >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>short</title>
    <style>
      :root {
        --color-primary: #5c7cfa;
        --color-primary-dark: #4263eb;
        --color-primary-alpha: #5c7cfa50;

        --body-color: #495057;
        --body-bg: #f8f9fa;

        --border-color: #dee2e6;
      }

      body {
        max-width: 60rem;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
        color: var(--body-color);
        background: var(--body-bg);
        font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.5;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        text-rendering: optimizelegibility;
        -webkit-font-smoothing: antialiased;
      }

      a {
        color: var(--color-primary);
        text-decoration: none;
        transition: color .3s;
      }

      a:hover {
        color: var(--color-primary);
        text-decoration: underline;
      }

      h1 {
        font-size: 5rem;
        font-weight: 300;
        text-align: center;
        opacity: .2;
        margin-top: 1rem;
        margin-bottom: 1rem;
      }

      main[x-cloak] {
        opacity: 0;
      }

      main:not([x-cloak]) {
        opacity: 1;
        transition: opacity .3s;
      }

      /* 修改：输入框容器样式 */
      .input-group {
        display: flex;
        align-items: center;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: .25rem;
        background: #fff;
        transition: border .3s, box-shadow .3s;
        padding: 0 .5rem; /* 容器内边距 */
      }

      .input-group:focus-within {
        box-shadow: 0 0 0 .25rem var(--color-primary-alpha);
        border-color: var(--color-primary);
      }

      /* 输入框前缀标签 */
      .input-prefix {
        color: #868e96;
        font-size: 0.9rem;
        margin-right: 0.5rem;
        white-space: nowrap;
        user-select: none;
      }

      /* 修改 input 样式以适应 group */
      input, select {
        -webkit-appearance: none;
        appearance: none;
        display: block;
        width: 100%;
        padding: .5rem 0; /* 移除左右 padding，由 group 控制 */
        border: none; /* 移除边框 */
        background: transparent;
        color: #33404d;
        line-height: inherit;
        font-size: 1rem;
        outline: 0; /* 移除 focus 轮廓 */
      }

      /* select 特殊处理 */
      select {
         padding-right: 1rem; /* 留出箭头位置 */
      }

      details {
        margin: 0.5rem 0 1rem;
        border: none;
        background: transparent;
        transition: background .3s;
      }

      details[open] {
        background: transparent;
      }

      details summary {
        padding: .5rem 0;
        font-weight: 500;
        user-select: none;
        cursor: pointer;
        opacity: .8;
        outline: 0;
        list-style: none;
      }

      details summary::-webkit-details-marker {
        display: none;
      }

      details summary::after {
        content: ' (点击展开/收起)';
        font-size: 0.8rem;
        opacity: 0.5;
        font-weight: normal;
      }

      details div {
        padding: 0;
        border-top: none;
        margin-top: 0.5rem;
      }

      details small {
        margin: 0;
        font-size: .875rem;
        line-height: 1.5;
        display: block;
        color: #868e96;
      }

      button {
        appearance: none;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        padding: .5rem .75rem;
        border: 1px solid var(--color-primary);
        border-radius: .25rem;
        background: var(--color-primary);
        color: #fff;
        font-size: 1rem;
        font-weight: 500;
        line-height: inherit;
        cursor: pointer;
        user-select: none;
        transition: border .3s, background .3s,;
      }

      button:hover {
        border-color: var(--color-primary-dark);
        background: var(--color-primary-dark);
      }

      button:focus {
        box-shadow: 0 0 0 .25rem var(--color-primary-alpha);
        border-color: var(--color-primary);
        outline: 0;
      }

      button:disabled {
        background: var(--color-primary);
        border-color: var(--color-primary);
        opacity: .6;
        cursor: not-allowed;
      }

      button.loading::before {
        content: '';
        display: inline-block;
        margin-right: .5rem;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-bottom-color: transparent;
        border-radius: 50%;
        width: .75rem;
        height: .75rem;
        animation: rotate .5s linear infinite;
      }

      .query-btn {
        background: #fff;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
      }
      .query-btn:hover {
        background: var(--color-primary-alpha);
        color: var(--color-primary-dark);
        border-color: var(--color-primary-dark);
      }

      footer {
        padding: 1rem;
        border-top: none;
        text-align: center;
        opacity: .5;
        margin-top: 1.5rem;
      }

      footer i {
        font-style: normal;
        color: #ff8787;
      }

      .success,
      .error {
        margin-bottom: 0.5rem;
        padding: .5rem 1rem;
        border-radius: .25rem;
        color: #fff;
        text-align: center;
        opacity: 1;
        transition: opacity .3s;
      }

      .success {
        border: 1px solid #12b886;
        background: #38d9a9;
      }

      .error {
        border: 1px solid #fa5252;
        background: #ff8787;
      }

      .row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .col {
        flex: 1;
      }
      .col-auto {
        flex: 0 0 auto;
      }

      @media (max-width: 600px) {
        .row {
          flex-direction: column;
          gap: 0.5rem;
          align-items: stretch;
        }
        .query-btn {
            width: 100%;
        }
      }

      .result-card {
        margin-top: 1rem;
        padding: 0.75rem;
        border: 1px solid var(--color-primary);
        border-radius: .25rem;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .result-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
        flex-wrap: wrap;
      }
      .result-item:last-child {
        margin-bottom: 0;
      }
      .result-label {
        font-weight: bold;
        margin-right: 0.5rem;
        min-width: 3.5rem;
        font-size: 0.9rem;
      }
      .result-value {
        flex: 1;
        word-break: break-all;
        margin-right: 0.5rem;
        font-family: monospace;
        background: #f1f3f5;
        padding: 0.1rem 0.4rem;
        border-radius: 0.2rem;
        font-size: 0.9rem;
      }
      .result-actions a, .result-actions span {
        margin-left: 0.5rem;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--color-primary);
      }

      .github-icon {
        display: inline-block;
        vertical-align: middle;
        width: 48px;
        height: 48px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'%3E%3Cpath fill='none' d='M0 0h24v24H0z'/%3E%3Cpath d='M12 2C6.475 2 2 6.475 2 12a9.994 9.994 0 0 0 6.838 9.488c.5.087.687-.213.687-.476 0-.237-.013-1.024-.013-1.862-2.512.463-3.162-.612-3.362-1.175-.113-.288-.6-1.175-1.025-1.413-.35-.187-.85-.65-.013-.662.788-.013 1.35.725 1.538 1.025.9 1.512 2.362 1.087 2.937.825.088-.65.35-1.087.638-1.337-2.225-.25-4.55-1.113-4.55-4.938 0-1.088.387-1.987 1.025-2.688-.1-.25-.45-1.275.1-2.65 0 0 .837-.262 2.75 1.026a9.28 9.28 0 0 1 2.5-.338c.85 0 1.7.112 2.5.338 1.912-1.287 2.75-1.025 2.75-1.025.55 1.375.2 2.4.1 2.65.637.7 1.025 1.587 1.025 2.687 0 3.838-2.337 4.688-4.562 4.938.362.312.675.912.675 1.85 0 1.337-.013 2.412-.013 2.75 0 .262.188.575.688.475A9.994 9.994 0 0 0 22 12c0-5.525-4.475-10-10-10z' fill='%23495057'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        opacity: 0.5;
        transition: opacity 0.3s;
      }

      .github-icon:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header><h1>short</h1></header>
    <main x-data="app" x-init="loadCustomSlugs()" x-cloak>
      <p x-show.transition.opacity="alert" :class="alert?.type" x-text="alert?.message"></p>

      <!-- 主输入框 -->
      <div class="row" style="margin-bottom: 0.5rem;">
          <div class="col">
            <div class="input-group">
                <span class="input-prefix">链接:</span>
                <input placeholder="输入要缩短的网址..." x-model="url" x-ref="url" />
            </div>
          </div>
          <div class="col-auto" x-show="url">
              <a :href="url" target="_blank" style="display: block; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: 0.25rem; background: #fff; font-size: 0.9rem;">访问</a>
          </div>
      </div>

      <details open>
        <summary>自定义设置 / 反查</summary>
        <div>

          <!-- 第一行：生成短链设置 -->
          <div class="row" style="margin-bottom: 0.25rem;">
            <div class="col">
                <div class="input-group">
                    <span class="input-prefix">后缀:</span>
                    <input placeholder="输入自定义后缀 (slug)，留空随机" x-model="slug" />
                </div>
            </div>
            <div class="col-auto">
                <button :class="{ loading }" :disabled="loading || isValidated()" @click="submit($refs, $nextTick)" style="margin-bottom: 0; width: auto; padding: 0.5rem 1rem;">生成</button>
            </div>
          </div>

          <div style="border-top: 1px dashed var(--border-color); margin: 0.25rem 0;"></div>

          <!-- 第二行：反查长链 -->
          <div class="row">
            <!-- 下拉列表 -->
            <div class="col">
                <div class="input-group">
                    <span class="input-prefix">历史:</span>
                    <select id="custom-slug-select" @change="selectCustomSlug($event.target.value)">
                      <option value="">-- 选择 --</option>
                      <template x-for="item in customSlugs" :key="item.slug">
                        <option :value="item.url" x-text="item.slug"></option>
                      </template>
                      <option value="" disabled x-show="customSlugs.length === 0">暂无</option>
                    </select>
                </div>
            </div>

            <!-- 手动输入 -->
            <div class="col">
                <div class="input-group">
                    <span class="input-prefix">反查:</span>
                    <input placeholder="输入后缀..." x-model="querySlug" />
                </div>
            </div>

            <!-- 查询按钮 -->
            <div class="col-auto">
                <button class="query-btn" style="margin: 0; width: auto; padding: 0.5rem 1rem;" @click="queryBySlug()" :disabled="!querySlug">查询</button>
            </div>
          </div>

        </div>
      </details>

      <!-- 结果展示区 -->
      <div class="result-card" x-show="resultShortUrl">
          <div class="result-item">
              <span class="result-label">短链:</span>
              <span class="result-value" x-text="resultShortUrl"></span>
              <div class="result-actions">
                  <span @click="copyToClipboard(resultShortUrl)">[复制]</span>
                  <a :href="resultShortUrl" target="_blank">[访问]</a>
              </div>
          </div>
          <div class="result-item">
              <span class="result-label">指向:</span>
              <span class="result-value" x-text="resultLongUrl" style="max-height: 3rem; overflow-y: auto; display: block;"></span>
              <div class="result-actions">
                  <a :href="resultLongUrl" target="_blank">[访问]</a>
              </div>
          </div>
      </div>

    </main>
    <footer>
     <a href="https://github.com/whua898/short" target="_blank" title="GitHub Repository">
        <span class="github-icon"></span>
     </a>
    </footer>
    <script src="asset/js/alpine.js"></script>
    <script>
      const app = {
        url: '',
        slug: '',
        querySlug: '',
        alert: null,
        loading: false,
        customSlugs: [],

        resultShortUrl: '',
        resultLongUrl: '',

        isValidated () {
          return !/^https?:\/\/.{3,}/.test(this.url)
        },

        loadCustomSlugs() {
          fetch('/list')
            .then(res => res.json())
            .then(res => {
              if (res.Code === 1 && Array.isArray(res.Data)) {
                this.customSlugs = res.Data;
              }
            })
            .catch(e => console.error('Failed to load custom slugs:', e));
        },

        selectCustomSlug(selectedUrl) {
          if (selectedUrl) {
            const selectedItem = this.customSlugs.find(item => item.url === selectedUrl);
            if (selectedItem) {
                this.querySlug = selectedItem.slug;
                this.queryBySlug();
            }
          }
        },

        queryBySlug() {
            if (!this.querySlug) return;

            this.loading = true;
            this.alert = null;
            this.resultShortUrl = '';

            fetch('/query', {
                method: 'post',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ slug: this.querySlug })
            })
            .then(res => res.json())
            .then(res => {
                this.loading = false;
                if (res.Code === 1) {
                    const shortUrl = `${window.location.origin}/${res.Slug}`;

                    this.resultShortUrl = shortUrl;
                    this.resultLongUrl = res.LongUrl;

                    this.url = res.LongUrl;
                    this.slug = res.Slug;

                    this.alert = { type: 'success', message: `查询成功！创建时间: ${res.CreateTime}` };
                } else {
                    this.alert = { type: 'error', message: res.Message || '未找到该短链' };
                }
            })
            .catch(e => {
                this.loading = false;
                this.alert = { type: 'error', message: e.message };
            });
        },

        copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    this.alert = { type: 'success', message: '已复制到剪贴板' };
                    setTimeout(() => this.alert = null, 2000);
                });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                this.alert = { type: 'success', message: '已复制到剪贴板' };
                setTimeout(() => this.alert = null, 2000);
            }
        },

        submit ($refs, $nextTick) {
          if (!this.url) {
            this.alert = { type: 'error', message: '缺少必需的参数：url。' }
            return
          }

          if (this.isValidated()) {
            this.alert = { type: 'error', message: '非法格式：url。' }
            return
          }

          this.alert = null
          this.loading = true
          this.resultShortUrl = '';

          const body = { url: this.url, overwrite: true }
          if (this.slug) body.slug = this.slug

          fetch('/short', {
            method: 'post',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(body)
          })
            .then(res => res.json())
            .then(res => {
              this.loading = false
              if (res.Code !== 1) {
                this.alert = { type: 'error', message: res.Message || '未知错误' }
                return
              }

              this.resultShortUrl = res.ShortUrl;
              this.resultLongUrl = this.url;

              if (this.slug) {
                  this.loadCustomSlugs();
              }

              this.alert = { type: 'success', message: '生成成功！' };

            })
            .catch(e => {
              this.alert = { type: 'error', message: e.message }
              this.loading = false
            })
        }
      }
    </script>
  </body>
</html>
